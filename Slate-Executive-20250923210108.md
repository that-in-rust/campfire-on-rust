# Slate Snapshot — 2025-09-23 21:01:08

Purpose
- Park a consolidated understanding of campfire-on-rust with three parts:
  A) Architectural brief, B) Targeted deep-dives, C) Architecture doc pointers
- Include a detailed, screen-by-screen user journey mapped to actual routes
- Capture Demo Mode vs Regular Mode user flows

Sources grounded
- Routes wired in src/main.rs (pages, assets, demo, api, ws, health, metrics)
- Handlers: auth.rs, rooms.rs, messages.rs, search.rs, websocket.rs, pages.rs (+ push, sounds, bot)
- Services: auth, room, message, search, push, bot, connection
- Parseltongue ISG snapshot: 541 nodes / 894 edges; visualization generated

A) Architectural brief (new-to-codebase fast orientation)
- App type: Axum server, single binary, SQLite (sqlx), WebSockets (feature-flagged), server-rendered HTML pages, static asset serving
- Core subsystems:
  - HTTP pages: root (/), /chat, /login, /demo, /manifest.json, /static/*, demo API
  - API: /api/auth, /api/users/me, /api/rooms (CRUD-lite), /api/rooms/:id/messages, /api/search, /api/sounds, /api/push/*, /api/bots/*
  - WebSocket: /ws (auth via query token/header/cookie), room presence, typing indicators, message creation
  - Health/metrics: /health, /health/{ready,live}, optional /metrics + /metrics/summary
- Config toggles (from Config.features):
  - websockets, search, sounds, push_notifications, bot_api, demo_mode
- Data & behavior highlights:
  - Auth sessions via cookies (HttpOnly; login sets SET-COOKIE)
  - Rooms: Open/Closed/Direct with membership
  - Messages: idempotent create with client_message_id deduplication (201 on success)
  - Search: FTS5-backed across authorized rooms
  - Push: VAPID-key based; disabled if not configured
  - Demo mode: initializer creates 8 demo users, 7 rooms; pages auto-detect via admin@campfire.demo

B) Targeted deep-dives (responsibilities and primary flows)
1) AuthService + Handlers (src/handlers/auth.rs)
- POST /api/auth/login: validates credentials, creates session, sets cookie; returns user + token (200)
- POST /api/auth/logout: revokes session; clears cookie (always 200)
- Session extraction via middleware::session tokens; WebSocket extracts from Bearer or Cookie
- Pages: GET /login (pages.rs) serves demo or regular login templates based on demo users

2) RoomService + Handlers (src/handlers/rooms.rs)
- GET /api/rooms: list rooms for current user (200)
- POST /api/rooms: create room (Open/Closed/Direct); returns (201, room)
- GET /api/rooms/:id: checks access; returns 200 or 403/404
- POST /api/rooms/:id/members: add member (201), enforces admin permissions, rich error mapping

3) MessageService + Handlers (src/handlers/messages.rs)
- POST /api/rooms/:room_id/messages: create with deduplication (201) or 400/403/429/500
- GET /api/rooms/:room_id/messages: history with pagination (limit<=100), returns {messages, has_more}
- Sanitization and validation paths; consistent error structure

4) WebSocket + ConnectionManager (src/handlers/websocket.rs)
- /ws upgrade with auth via query/header/cookie
- Incoming:
  - CreateMessage: goes through MessageService (dedup)
  - UpdateLastSeen: tracking for reconnection
  - JoinRoom/LeaveRoom: access checks + presence broadcasts + presence updates
  - StartTyping/StopTyping: typing indicators + broadcasts
- Outgoing: errors/pongs; manager broadcasts room events and presence changes

5) SearchService + Handler (src/handlers/search.rs)
- GET /api/search?q=...&limit=&offset=&room_id=
- Validates request; sanitizes query; returns typed SearchResponse or structured error with StatusCode::from(err)

6) PushNotificationService + Handlers (src/handlers/push.rs)
- If enabled: manage subscriptions, preferences, get VAPID public key; optional test endpoint in debug
- No-ops if feature disabled or keys absent

7) BotService + Handlers (src/handlers/bot.rs)
- If enabled: CRUD for bots, reset token, and message creation endpoint:
  - POST /rooms/:room_id/bot/:bot_key/messages

8) Demo data + Pages (src/handlers/pages.rs, src/demo.rs)
- GET / and GET /login dynamically choose demo vs regular path based on demo users present
- /api/demo/status, /api/demo/initialize bootstrap flows
- Assets: /demo, /chat, /manifest.json, /static/*

C) Architecture docs pointers
- Parseltongue visualization:
  - parseltongue_workspace/analysis_20250923193618/architecture.html
- Component contexts (human+json):
  - parseltongue_workspace/analysis_20250923193618/context_*.{txt,json}
- How to regenerate:
  - Build FILE:-header dump of src/tests, ingest, run visualize & generate-context

Screen-by-screen user journey (mapped to routes/handlers)

Demo Mode vs Regular Mode detection
- Pages decide based on existence of admin@campfire.demo:
  - If demo users present → demo mode on (pages.rs)
  - Otherwise → regular mode (no seeded data)

0) Root
- GET / (pages.rs)
  - Demo Mode: serves demo landing (assets::serve_demo_page)
  - Regular Mode: serves chat interface (assets::serve_chat_interface) or relies on /login + SPA view
  - Related: GET /demo (demo landing page), GET /manifest.json, GET /static/*

1) Login
- GET /login (pages.rs): serves login_demo.html or login.html
- POST /api/auth/login (auth.rs): returns 200 + user + session_token and sets cookie
- POST /api/auth/logout (auth.rs): clears cookie, 200

2) Rooms (index/dashboard)
- GET /api/rooms (rooms.rs): JSON list of rooms for sidebar/dashboard rendering
- Create Room:
  - POST /api/rooms (rooms.rs): 201; body: {name, topic?, room_type: Open|Closed|Direct}
- View Room details:
  - GET /api/rooms/:id (rooms.rs): 200 or 403/404; used to gate room view
- Membership:
  - POST /api/rooms/:id/members (rooms.rs): 201; admin-only adds Member/Admin

3) Room Chat View
- Data:
  - GET /api/rooms/:id/messages (messages.rs): {messages[], has_more}; supports limit<=100; optional before
- Compose:
  - POST /api/rooms/:id/messages (messages.rs): 201 on success
  - Content sanitized; client_message_id (UUID) enforces idempotency
- Real-time:
  - GET /ws (websocket.rs): authenticate via token/header/cookie
  - Incoming client events: CreateMessage, UpdateLastSeen, JoinRoom, LeaveRoom, StartTyping, StopTyping
  - Broadcasts: message events, typing start/stop, user join/leave, presence updates

4) Direct Messages
- Create/find DM room:
  - Typically via POST /api/rooms with room_type = Direct or a dedicated DM route (not explicitly wired; DM is a specialized room)
- Then same messaging/search flow as rooms

5) Search
- GET /api/search (search.rs): q=..., (limit, offset, optional room_id)
- Returns SearchResponse (results across authorized rooms) or structured error

6) Sounds (feature: sounds)
- GET /api/sounds, GET /api/sounds/:sound_name, GET /api/sounds/:sound_name/info (sounds.rs)
- Users can issue /play <sound> in chat; this endpoint supports sound discovery

7) Notifications (feature: push_notifications)
- GET /api/push/vapid-key: retrieve public key for browser registration
- POST /api/push/subscriptions: register push subscription
- DELETE /api/push/subscriptions/:id
- GET/PUT /api/push/preferences: per-user notification preferences
- Optional debug-only POST /api/push/test

8) Bots (feature: bot_api)
- CRUD: /api/bots (list/create), /api/bots/:id (get/put/delete), /api/bots/:id/reset-token
- Post message as bot:
  - POST /rooms/:room_id/bot/:bot_key/messages

9) Health & Metrics
- GET /health, /health/ready, /health/live
- If metrics enabled: GET /metrics (configurable endpoint), GET /metrics/summary

End-to-end user flows

Regular first-run (no demo data)
1) Visit /login → sign in (or go via / → chat interface requiring auth)
2) GET /api/rooms (empty) → Create room POST /api/rooms (201) → now visible
3) Open room: GET /api/rooms/:id (authorize) → GET /api/rooms/:id/messages (history)
4) Connect /ws → send messages (POST /api/rooms/:id/messages or via WS CreateMessage)
5) Enable search (GET /api/search) as needed; optionally enable push if VAPID configured

Demo evaluation (demo mode on)
1) Visit / → demo landing (/demo) and login page shows demo UX (login_demo.html)
2) One-click demo login (UI) → session cookie set
3) Pre-seeded rooms and conversations presented; WS live behavior visible
4) Explore @mentions, /play sounds, search; optional Demo API: /api/demo/status
5) Exit demo by disabling feature or switching to regular setup

Notes & decisions
- Prefer 201 Created on resource creation (rooms, messages, add_member)
- WebSocket auth accepts session token via query/header/cookie → simplify clients
- Demo mode is explicitly supported in code; if adopting DHH-only path later, gate via config.features.demo_mode=false
- Screen rendering is via static/SPA and template pages; server endpoints supply JSON

Next steps (optional enhancements)
- Route inventory doc (generated from main.rs) co-located with this snapshot
- Link each screen to its Askama/HTML template (templates/*) and handler function name
- Add reconnection/presence UATs before shipping (cover JoinRoom/LeaveRoom/UpdateLastSeen)
- Confirm attach/preview deferrals are user-messaged in UI (avoid dead controls)

References
- Routes wiring: src/main.rs
- Handlers: src/handlers/*.rs (auth, pages, rooms, messages, search, websocket, push, sounds, bot)
- Services: src/services/*.rs (auth, room, message, search, push, bot, connection)
- Parseltongue outputs: parseltongue_workspace/analysis_20250923193618/