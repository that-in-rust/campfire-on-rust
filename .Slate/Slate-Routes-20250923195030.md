# Slate Snapshot — 2025-09-23 19:50:30

Purpose
- New consolidated snapshot capturing: (A) New-to-codebase architectural brief, (B) targeted deep-dives, (C) architecture docs pointers, and a detailed screen-by-screen user journey (mapped to handlers/routes where applicable).

Parseltongue first pass (context)
- Snapshot generated from 54 Rust files → 541 nodes, 894 edges (Signature Interface Graph).
- Visualization: parseltongue_workspace/analysis_20250923193618/architecture.html
- Entity list: parseltongue_workspace/analysis_20250923193618/all_entities.txt
- Component contexts (txt/json): AppState, AuthService, RoomService, MessageService, SearchService, PushNotificationServiceImpl, BotServiceImpl, ConnectionManagerImpl (same folder).

A) New-to-codebase architectural brief
- App type: Axum-based, single binary, SQLite, server-rendered HTML (Askama/HTMX style).
- Layers:
  - HTTP handlers: auth, pages, rooms, messages, search, push, sounds, users, bot.
  - WebSocket: room-based broadcasting; presence/typing via connection manager.
  - Services: auth, room, message, search, push, bot, connection.
  - Middleware: session, security.
  - Support: errors, validation, metrics, health, shutdown, logging, assets, rich_text, demo (placeholder).
- Data:
  - SQLite schema (users, rooms, messages, memberships, sessions).
  - FTS5 for message search with triggers to keep index in sync.
- Key behaviors:
  - Session cookies; bcrypt auth.
  - Idempotent message creation via client_message_id deduplication.
  - Real-time broadcasts to room subscribers.
  - FTS5 search; optional Web Push via VAPID.
- Deployment:
  - Single binary; Docker-ready; health/metrics endpoints; configurable via env.

B) Targeted deep-dives (service responsibilities and flows)
1) AuthService
- Login: verify email/password; create session token; set cookie.
- Session: create/validate/revoke; secure defaults (expiry/rotation/secure flag).
- First-run: detect empty DB; render setup flow (create admin) → establish session.
- Handlers: src/handlers/auth.rs; session middleware in src/middleware/session.rs.

2) RoomService
- CRUD-lite for rooms; types: Open/Closed/Direct; membership management.
- Handlers: src/handlers/rooms.rs (create/join/leave/list).

3) MessageService
- create_message_with_deduplication(content, room_id, user_id, client_message_id)
  - Validate membership, sanitize content, length 1..=10000.
  - Insert into messages; if UNIQUE(client_message_id, room_id) conflict → return existing.
  - Update room.last_message_at; broadcast via WebSocket to room subscribers.
- History: get_room_messages(room_id, user_id, limit, before).
- Handlers: src/handlers/messages.rs.

4) ConnectionManager (WebSocket)
- Tracks user connections; join/leave room channels; broadcast message events.
- Presence: get_room_presence(room_id) → list of users; typing indicators.
- Reconnect: send_missed_messages(last_seen_message_id).
- Handler: src/handlers/websocket.rs; service: src/services/connection.rs.

5) SearchService
- FTS5-backed message search; returns content with context and timestamps.
- Handler: src/handlers/search.rs.

6) PushNotificationService
- Sends notifications (mentions/DMs) when VAPID configured; no-op otherwise.
- Handler: src/handlers/push.rs; service: src/services/push.rs.

7) BotService
- Token-based posting to rooms; example bot workflow.
- Handler: src/handlers/bot.rs; service: src/services/bot.rs.

C) Architecture docs pointers and how to regenerate
- Visualization: parseltongue_workspace/analysis_20250923193618/architecture.html
- Contexts: parseltongue_workspace/analysis_20250923193618/context_*.txt/.json
- Regenerate:
  - Dump: parseltongue_workspace/dumps/campfire_YYYYMMDDHHMMSS.dump (FILE:-header format)
  - Ingest + outputs: parseltongue_workspace/analysis_YYYYMMDDHHMMSS/
  - Commands: ./parseltongue_workspace/parseltongue ingest …; debug --graph; visualize —output …

Screen-by-screen user journey (with handlers/routes mapping)
Note: Exact route strings may vary slightly; the mapping aligns with handler modules.

0) Root and First-Run (DB empty)
- Screen: First-Run Setup
  - Route: GET / (pages.rs) → detects empty DB → render setup page.
  - Action: POST /setup (pages/auth) → create admin (AuthService), set session, redirect.
  - After: Suggest “Create your first room”.
- If DB not empty → redirect to /login or /rooms per session.

1) Authentication
- Login Screen
  - GET /login (auth.rs) → render login.
  - POST /login → validate credentials, create session cookie → redirect /rooms.
  - Logout: POST /logout → revoke session; redirect /login.
- Session middleware
  - src/middleware/session.rs ensures downstream handlers see authenticated user or reject with 401.

2) Rooms Index (sidebar home)
- Screen: Rooms List / Dashboard
  - GET /rooms (rooms.rs/pages.rs) → list joined rooms + discover open rooms.
  - Actions:
    - “Create Room” → GET/POST /rooms/new (rooms.rs)
      - Fields: name, type (Open/Closed/Direct), topic.
      - On success: 201 Created; redirect to room view; sidebar updates.
    - Join/Leave open rooms: POST /rooms/:id/join, POST /rooms/:id/leave.
    - Invite (Closed rooms): POST /rooms/:id/invite (authorized users).
  - Presence: count fetched via ConnectionManager; displayed per room.

3) Room Chat View
- Screen: Room Timeline
  - GET /rooms/:id (rooms.rs/messages.rs) → server-rendered message history (paginated).
  - Composer: POST /rooms/:id/messages (messages.rs)
    - Payload: content, client_message_id (UUID).
    - Deduplication: idempotent behavior if same client_message_id re-sent.
  - Real-time:
    - WS: GET /ws (websocket.rs) with room subscription message on open.
    - Events: message broadcast, typing indicators, join/leave, presence updates.
  - Sounds: /play commands (handlers/sounds.rs and sounds.rs).

4) Direct Messages
- Screen: DM Conversation
  - GET /dms/:user_id or a synthetic room id for direct rooms (rooms.rs/messages.rs).
  - Start DM: POST /dms/start (rooms.rs) → create/find Direct room; redirect to DM.

5) Search
- Screen: Search
  - GET /search (search.rs) with query param q=… → FTS5-backed results across rooms user can access.
  - Results: show snippet, room name, timestamp; link to message/room anchor.

6) Notifications (Web Push)
- Screen: Notifications Settings
  - GET /notifications (push.rs/pages.rs) → if VAPID set, allow browser registration; else show “configure in production”.
  - POST /notifications/register → stores subscription for current user.

7) Users / Account
- Screen: Account/Profile
  - GET /account (users.rs) → display name, bio; avatar initials (uploads deferred).
  - POST /account → update profile fields.
  - Bot token management (if exposed here or via admin).

8) Admin Area (admin only)
- Screens: Users, Rooms, Settings, Bots
  - GET /admin (pages.rs) → dashboard.
  - Users: list/disable; Rooms: membership/admins; Settings: app config preview; Bots: token admin.

9) Health/Operational
- Health: GET /health (health.rs)
- Readiness/Metrics: GET /ready, GET /metrics (metrics.rs) as configured.

Primary end-to-end flows
- First-run to first message (solo):
  1) Visit / → setup admin → /rooms → create room → /rooms/:id → send message.
- Team onboarding (closed room):
  1) Admin creates closed room → invites user → user registers/logs in → joins room → chat live via WS.
- Discovery (open rooms):
  1) User logs in → joins #general (open) → chat live; search history; enable push if configured.

Practical differences vs original Campfire (Rails)
- Attachments/previews: deferred with “Coming in v2.0” messaging.
- Status: creation routes prefer 201 Created; adjust tests accordingly.
- Offline-first: single binary + SQLite; push optional (VAPID-gated).

Next steps (optional enhancements to this snapshot)
- Route Inventory: extract concrete route table from main.rs/router wiring and append here.
- Handler ↔ Template map: list for each screen the Askama template and handler function.
- Journey-linked tests: list integration/UAT test names for each screen and core flow.

References
- Code structure: src/handlers/*.rs, src/services/*.rs, middleware/, models/, validation/, health.rs, metrics.rs, assets.rs, rich_text.rs.
- Parseltongue outputs: parseltongue_workspace/analysis_20250923193618/
- Prior notes: Slate20250923192202.md, Slate20250923194000.md (root).