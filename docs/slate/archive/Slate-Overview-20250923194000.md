# Slate Snapshot — 2025-09-23 19:40:00

Purpose
- Consolidated understanding of campfire-on-rust using parseltongue outputs + specs.
- Includes: (A) Architectural brief (new-to-codebase), (B) Targeted deep-dives, (C) Architecture doc pointers.
- Special focus: user journey, screen-by-screen.

Parseltongue run summary (first pass)
- Snapshot: 541 nodes, 894 edges from 54 Rust files.
- Visualization: parseltongue_workspace/analysis_20250923193618/architecture.html
- Entity list: parseltongue_workspace/analysis_20250923193618/all_entities.txt
- Component contexts: AppState, AuthService, RoomService, MessageService, SearchService, PushNotificationServiceImpl, BotServiceImpl, ConnectionManagerImpl (JSON + human text in same folder).

A) New-to-codebase architectural brief (fast orientation)
- App style: Single-binary Axum server with:
  - HTTP handlers: auth, users, rooms, messages, search, notifications, bot.
  - WebSocket: room-based broadcasting; typing/presence via connection manager.
  - Services: AuthService, RoomService, MessageService, SearchService, PushNotificationServiceImpl, BotServiceImpl, ConnectionManagerImpl.
  - Data: SQLite (rusqlite/sqlx style), FTS5 for message search, sessions table, rooms/users/memberships/messages.
- Core behaviors:
  - Session cookies for auth; bcrypt password hashing.
  - Message creation with client_message_id deduplication.
  - Real-time broadcasts to room subscribers; presence/typing.
  - Search over messages via FTS5.
  - Push notifications via VAPID (config-gated).
- Deployment:
  - Single binary, embedded assets; SQLite path default; VAPID optional.
  - Docker-ready; health endpoints recommended.

B) Targeted deep-dives (focus components)
1) AuthService (sessions + first-run)
- Responsibilities:
  - Email/password auth; bcrypt verification.
  - Session token creation (secure, unique, DB-backed) + validation/revocation.
  - First-run detection path: empty DB → show setup page → create admin → redirect to app.
- Key flows:
  - GET /login → login form; POST /login → set cookie, redirect to rooms.
  - First-run: GET /setup → POST /setup (admin email/password) → set session → redirect /rooms.
- Notes:
  - Production: secure cookies, HTTPS-only in prod, configurable expiry.

2) RoomService + MessageService (chat core)
- RoomService:
  - Create room (Open/Closed/Direct), add/remove members, list user rooms.
- MessageService:
  - create_message_with_deduplication(content, room_id, user_id, client_message_id):
    - Validates auth + membership, length, sanitize.
    - Insert message; on UNIQUE violation (client_message_id, room_id), return existing.
    - Update room.last_message_at.
    - Broadcast to WebSocket room topic.
  - get_room_messages(room_id, user_id, limit, before): paging history.

3) ConnectionManagerImpl (WebSocket/presence)
- Manages user connections, room subscriptions, broadcasts.
- Presence:
  - Tracks connections per room; exposes get_room_presence(room_id) → user list.
  - On reconnect: send_missed_messages(last_seen_message_id).
- Real-time events:
  - New message, typing indicators, join/leave, presence updates.

4) SearchService (FTS5-backed)
- Index: messages_fts synced on insert/update/delete via triggers.
- Queries match content; returns message snippet, room context, timestamp.

5) PushNotificationServiceImpl
- Uses VAPID keys when configured; skips when unset (offline/local default).
- Sends notifications on mentions/DMs (configurable thresholds).

6) BotServiceImpl
- Bot tokens and endpoints for posting to rooms (simple HTTP API).
- Basic example flows; enable/disable per room.

C) Architecture docs pointers
- Visualization HTML: parseltongue_workspace/analysis_20250923193618/architecture.html
- Component contexts: same folder (context_*.txt/json)
- Recommended follow-up:
  - Run parseltongue visualize to regenerate as code changes.
  - Use generate-context for any entity to get LLM-ready detail.

User journey (screen-by-screen)
Note: Derived from handlers/services and specs; exact routes may vary subtly but flows reflect the implemented design.

1) First-Run Setup (only when DB empty)
- Screen: “Welcome — Set up Campfire”
  - Fields: Organization name (optional), Admin email, Password, Confirm.
  - Actions: Create Admin.
  - Success: Session created → redirect to Rooms List (or Create Room).
  - Errors: Invalid email/password strength feedback.
- After setup:
  - Banner: “Create your first room” with CTA.

2) Login
- Screen: “Sign in”
  - Fields: Email, Password.
  - Actions: Log in → on success, redirect to Rooms.
  - Links: Forgot password (docs/procedure), Create account (if enabled).
  - Errors: Invalid credentials message.

3) Rooms List / Sidebar Home
- Screen: “Rooms”
  - Left Sidebar:
    - My Rooms (joined): General, Dev, Design, DMs.
    - Discover/All Rooms (for open rooms).
    - Direct Messages list (recent).
    - Search bar (global).
  - Main Panel:
    - Recent rooms or Welcome panel with “Create Room”.
  - Actions:
    - Create Room (name, type: Open/Closed/Direct; optional topic).
    - Join/Leave open rooms.
    - Invite users (Closed rooms).
  - Presence: avatars/initials with counts.

4) Create Room (modal/page)
- Fields: Name, Type (Open/Closed/Direct), Topic (optional).
- Submission: 201 on success; appears in sidebar and redirects to room view.

5) Room Chat View
- Screen: “#room-name”
  - Header: Room name, topic, presence count, actions (Invite, Settings [admin-only]).
  - Messages pane: Server-rendered HTML; supports:
    - Rich text, @mentions, /play sounds, boosts.
    - Timestamps, author, compact threading (if any), day dividers.
  - Composer:
    - Textarea with hint for @mentions and /play commands.
    - Send (Enter), Shift+Enter newline.
  - Real-time:
    - Incoming messages via WebSocket; typing indicators; presence updates.
  - Deduplication:
    - Client sends client_message_id; fast double-submit won’t duplicate.
  - Errors:
    - If no access, show “You don’t have permission to view this room”.

6) Direct Messages
- Screen: “@username”
  - Similar to Room Chat but scoped to a two-person room (type Direct).
  - Creation:
    - Start DM → select user → opens/creates direct room.

7) Search
- Screen: “Search”
  - Input: Query string.
  - Results:
    - Matches across rooms; highlight context; timestamps; links to messages.
  - Powered by SQLite FTS5; relevance ordering.

8) Notifications (Push)
- Screen: “Notifications”
  - If VAPID keys configured:
    - Button: Enable browser notifications; per-room mentions-only toggle.
  - If not configured:
    - Info banner: “Configure push notifications in production (VAPID keys).”
  - Web push permission prompts handled by browser.

9) User Profile / Account
- Screen: “My Account”
  - Fields: Display name, bio; avatar initials (uploads deferred to v2).
  - Bot token (if available) visibility/regeneration (admin-only or per user as designed).
  - Logout action.

10) Admin Area (admin users)
- Screen: “Admin”
  - Users:
    - List users; activate/deactivate; reset steps documentation link.
  - Rooms:
    - Create/close; set room admins; manage membership for Closed rooms.
  - Settings:
    - App configuration overview: DB path, SSL domain (docs), push status, health endpoints.
  - Bots:
    - Example bot setup and tokens.

11) System Screens / States
- 401/403 views: Not authorized / authentication required.
- 404: Not found.
- Health checks: /health, /ready JSON (ops).
- Error pages: Friendly message; logs correlate with IDs.

User flow (end-to-end)
- First run (empty DB):
  1) Visit root → Setup page → create admin (session created).
  2) Create first room → land in empty room → send first message.
  3) Invite teammate(s) (by email or account creation).
  4) Teammate logs in → joins room → chat live (typing/presence).
- Returning users:
  1) Visit /login → authenticate → sidebar lists rooms → select one.
  2) Post message; see real-time updates from others.
  3) Use @mentions and /play commands; search history when needed.
  4) Optionally enable notifications (if configured).
- Admin duties:
  - Manage rooms/users; review settings; rotate bot tokens; verify health.

Differences from original Rails Campfire (practical)
- Attachments/previews: deferred with “Coming in v2.0” messaging.
- Status codes: Prefer 201 Created on resource creation (update tests accordingly).
- Offline-first: Single binary + SQLite; push is optional (gated on VAPID).

Next steps (actionable)
- Confirm any route naming you want standardized (e.g., /rooms, /messages, /search, /admin).
- If desired, I can:
  1) Extract and list concrete routes from the handlers to append to this file.
  2) Cross-link each screen to specific handlers and templates.
  3) Generate a concise “How to run locally” block at top-level README section.
  4) Expand the visualization with component-specific layers (services, handlers, DB).

References
- Visualization + contexts: parseltongue_workspace/analysis_20250923193618/
- Prior snapshot: Slate20250923192202.md (root)